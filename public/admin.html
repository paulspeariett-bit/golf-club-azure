<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClubVision System Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            line-height: 1.6;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #1e293b;
            color: white;
            padding: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 24px;
            background: #0f172a;
            border-bottom: 1px solid #334155;
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #f1f5f9;
        }

        .sidebar-header p {
            font-size: 14px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .sidebar-nav {
            padding: 16px 0;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            padding: 0 24px 8px;
            font-size: 12px;
            text-transform: uppercase;
            color: #64748b;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .nav-item {
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
        }

        .nav-item:hover {
            background: #334155;
            border-left-color: #3b82f6;
        }

        .nav-item.active {
            background: #1e40af;
            border-left-color: #60a5fa;
        }

        .nav-item-icon {
            margin-right: 12px;
            font-size: 16px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .main-header {
            background: white;
            padding: 20px 32px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .content-area {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .dashboard-card h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #64748b;
        }

        /* Tables */
        .data-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .table-header {
            padding: 20px 24px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Onboarding embed */
        .onboarding-embed {
            width: 100%;
            height: 800px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .onboarding-embed iframe {
            width: 100%;
            height: 100%;
            border: 0;
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 16px 24px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        td {
            color: #4b5563;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Hidden sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .close-btn:hover {
            background: #f3f4f6;
        }

        /* Login Form */
        .login-form {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .login-header p {
            color: #64748b;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .content-area {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginForm" class="login-form">
        <div class="login-header">
            <h1>ClubVision Admin</h1>
            <p>System Administrator Dashboard</p>
        </div>
        <div id="loginError" class="alert alert-error hidden"></div>
        <form onsubmit="adminLogin(event)">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="adminUsername" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="adminPassword" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Login to Admin Dashboard</button>
        </form>
        <p style="margin-top: 20px; text-align: center; font-size: 12px; color: #666;">
            System Admin access only
        </p>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="admin-container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>ClubVision</h1>
                <p>System Administration</p>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                    <div class="nav-item active" onclick="showSection('dashboard')">
                        <span class="nav-item-icon">üìä</span>
                        Dashboard
                    </div>
                    <div class="nav-item" onclick="showSection('analytics')">
                        <span class="nav-item-icon">üìà</span>
                        Analytics
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <div class="nav-item" onclick="showSection('organizations')">
                        <span class="nav-item-icon">üè¢</span>
                        Organizations
                    </div>
                    <div class="nav-item" onclick="showSection('sites')">
                        <span class="nav-item-icon">üèåÔ∏è</span>
                        Sites & Clubs
                    </div>
                    <div class="nav-item" onclick="showSection('screens')">
                        <span class="nav-item-icon">üì∫</span>
                        Screen Management
                    </div>
                    <div class="nav-item" onclick="showSection('onboarding')">
                        <span class="nav-item-icon">üß≠</span>
                        Onboarding
                    </div>
                    <div class="nav-item" onclick="showSection('users')">
                        <span class="nav-item-icon">üë•</span>
                        User Management
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">System</div>
                    <div class="nav-item" onclick="showSection('settings')">
                        <span class="nav-item-icon">‚öôÔ∏è</span>
                        System Settings
                    </div>
                    <div class="nav-item" onclick="showSection('logs')">
                        <span class="nav-item-icon">üìã</span>
                        System Logs
                    </div>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="main-header">
                <h2 id="sectionTitle">Dashboard</h2>
                <div class="site-context" style="display:flex; align-items:center; gap:8px; margin-right:auto; margin-left:24px;">
                    <label for="activeSiteSelect" style="font-size:12px; color:#64748b;">Active Site:</label>
                    <select id="activeSiteSelect" style="padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; min-width:220px;"></select>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="adminUserInfo">Admin User</span>
                    <button class="logout-btn" onclick="adminLogout()">Logout</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="content-section active">
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <h3>Total Organizations</h3>
                            <div class="stat-value" id="totalOrganizations">1</div>
                            <div class="stat-label">Active organizations</div>
                        </div>
                        <div class="dashboard-card">
                            <h3>Active Sites</h3>
                            <div class="stat-value" id="totalSites">1</div>
                            <div class="stat-label">Golf clubs & venues</div>
                        </div>
                        <div class="dashboard-card">
                            <h3>Total Users</h3>
                            <div class="stat-value" id="totalUsers">-</div>
                            <div class="stat-label">All user accounts</div>
                        </div>
                        <div class="dashboard-card">
                            <h3>System Status</h3>
                            <div class="stat-value" style="color: #10b981;">ONLINE</div>
                            <div class="stat-label">All systems operational</div>
                        </div>
                    </div>

                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">Recent Activity</h3>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Event</th>
                                    <th>Site</th>
                                    <th>User</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivity">
                                <tr>
                                    <td>System initialized</td>
                                    <td>ClubVision Platform</td>
                                    <td>System</td>
                                    <td>Just now</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Organizations Section -->
                <div id="organizations-section" class="content-section">
                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">Organizations</h3>
                            <button class="btn btn-primary" onclick="showModal('organizationModal')">Add Organization</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Organization</th>
                                    <th>Sites</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="organizationsList">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sites Section -->
                <div id="sites-section" class="content-section">
                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">Sites & Clubs</h3>
                            <button class="btn btn-primary" onclick="showModal('siteModal')">Add Site</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Site Name</th>
                                    <th>Organization</th>
                                    <th>Status</th>
                                    <th>Users</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sitesList">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users-section" class="content-section">
                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">User Management</h3>
                            <button class="btn btn-primary" onclick="showModal('userModal')">Add User</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Site</th>
                                    <th>Last Login</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersList">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Screens Section -->
                <div id="screens-section" class="content-section">
                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">Screen Management</h3>
                            <button class="btn btn-primary" onclick="generateTestScreen()">Generate Test Pairing</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Pairing Code</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Last Seen</th>
                                    <th>Activated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="screensList">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Onboarding Section -->
                <div id="onboarding-section" class="content-section">
                    <div class="data-table" style="border:none; box-shadow:none;">
                        <div class="table-header" style="background:#fff; border:1px solid #e2e8f0; border-bottom:none; border-top-left-radius:12px; border-top-right-radius:12px;">
                            <h3 class="table-title">Onboarding Wizard</h3>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <a id="onboardingNewTab" class="btn btn-secondary btn-sm" href="/onboarding-wireframe.html" target="_blank">Open in new tab</a>
                                <button class="btn btn-primary btn-sm" onclick="reloadOnboarding()">Reload</button>
                            </div>
                        </div>
                        <div class="onboarding-embed">
                            <iframe id="onboardingFrame" src="/onboarding-wireframe.html" title="Onboarding"></iframe>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings-section" class="content-section">
                    <div class="dashboard-card">
                        <h3>System Settings</h3>
                        <form id="systemSettingsForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Platform Name</label>
                                    <input type="text" id="platformName" value="ClubVision">
                                </div>
                                <div class="form-group">
                                    <label>Default Time Zone</label>
                                    <select id="defaultTimeZone">
                                        <option value="UTC">UTC</option>
                                        <option value="GMT">GMT</option>
                                        <option value="EST">EST</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>System Maintenance Message</label>
                                <textarea id="maintenanceMessage" rows="3" placeholder="Enter maintenance message (optional)"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Settings</button>
                        </form>
                    </div>
                </div>

                <!-- Analytics Section -->
                <div id="analytics-section" class="content-section">
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <h3>Active Sessions</h3>
                            <div class="stat-value" id="activeSessions">0</div>
                            <div class="stat-label">Current user sessions</div>
                        </div>
                        <div class="dashboard-card">
                            <h3>API Requests</h3>
                            <div class="stat-value" id="apiRequests">-</div>
                            <div class="stat-label">Last 24 hours</div>
                        </div>
                        <div class="dashboard-card">
                            <h3>Screen Pairs</h3>
                            <div class="stat-value" id="screenPairs">-</div>
                            <div class="stat-label">Active screen connections</div>
                        </div>
                        <div class="dashboard-card">
                            <h3>Storage Usage</h3>
                            <div class="stat-value" id="storageUsage">-</div>
                            <div class="stat-label">Media storage used</div>
                        </div>
                    </div>
                </div>

                <!-- Logs Section -->
                <div id="logs-section" class="content-section">
                    <div class="data-table">
                        <div class="table-header">
                            <h3 class="table-title">System Logs</h3>
                            <button class="btn btn-secondary" onclick="refreshLogs()">Refresh</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Level</th>
                                    <th>Event</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="systemLogs">
                                <tr>
                                    <td>2025-09-17 10:30:00</td>
                                    <td><span class="status-badge status-active">INFO</span></td>
                                    <td>System Started</td>
                                    <td>ClubVision platform initialized successfully</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Organization Modal -->
    <div id="organizationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="organizationModalLabel" class="modal-title">Add Organization</h3>
                <button class="close-btn" onclick="hideModal('organizationModal')">&times;</button>
            </div>
            <form id="organizationForm" onsubmit="saveOrganization(event)">
                <div class="form-group">
                    <label>Organization Name</label>
                    <input type="text" id="orgName" required>
                </div>
                <div class="form-group">
                    <label>Organization Slug <span style="font-size:0.9em;color:#888;">(URL-friendly, e.g. test-org)</span></label>
                    <input type="text" id="orgSlug" placeholder="e.g. test-org">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Contact Email</label>
                        <input type="email" id="orgEmail">
                    </div>
                    <div class="form-group">
                        <label>Contact Phone</label>
                        <input type="tel" id="orgPhone">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="orgDescription" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('organizationModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Organization</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Site Modal -->
    <div id="siteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="siteModalLabel" class="modal-title">Add Site</h3>
                <button class="close-btn" onclick="hideModal('siteModal')">&times;</button>
            </div>
            <form id="siteForm" onsubmit="saveSite(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Site Name</label>
                        <input type="text" id="siteName" required>
                    </div>
                    <div class="form-group">
                        <label>Site Slug</label>
                        <input type="text" id="siteSlug" required placeholder="e.g., greenfield-golf">
                    </div>
                </div>
                <div class="form-group">
                    <label>Organization</label>
                    <select id="siteOrganization" required>
                        <option value="">Select Organization</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Site URL</label>
                    <input type="url" id="siteUrl" placeholder="https://example.com">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Contact Email</label>
                        <input type="email" id="siteEmail">
                    </div>
                    <div class="form-group">
                        <label>Contact Phone</label>
                        <input type="tel" id="sitePhone">
                    </div>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="siteAddress" rows="2"></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('siteModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Site</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalLabel" class="modal-title">Add User</h3>
                <button class="close-btn" onclick="hideModal('userModal')">&times;</button>
            </div>
            <form id="userForm" onsubmit="saveUser(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="userName" required>
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="userFullName">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="userEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="userRole" required>
                            <option value="">Select Role</option>
                            <option value="system_admin">System Admin</option>
                            <option value="admin">Site Admin</option>
                            <option value="content_manager">Content Manager</option>
                            <option value="viewer">Viewer</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Site</label>
                    <select id="userSite" required>
                        <option value="">Select Site</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="userPassword" required>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="hideModal('userModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let authToken = localStorage.getItem('adminAuthToken');
        let currentAdmin = JSON.parse(localStorage.getItem('currentAdmin') || '{}');

        // Initialize admin dashboard
        if (authToken && currentAdmin.role === 'system_admin') {
            showAdminDashboard();
            loadDashboardData();
            loadSitesForActiveSelector();
        } else {
            showAdminLogin();
        }

        function showAdminLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
        }

        function showAdminDashboard() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            
            if (currentAdmin.username) {
                document.getElementById('adminUserInfo').textContent = `${currentAdmin.username} (${currentAdmin.role})`;
                document.getElementById('userAvatar').textContent = currentAdmin.username.charAt(0).toUpperCase();
            }
        }

        async function adminLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Handle both old and new response formats
                    let user = data.user;
                    if (!user) {
                        // Old format - create user object
                        user = {
                            username: 'admin',
                            role: 'system_admin',
                            name: 'System Administrator'
                        };
                    }
                    
                    if (user.role === 'system_admin') {
                        localStorage.setItem('adminAuthToken', data.token);
                        localStorage.setItem('currentAdmin', JSON.stringify(user));
                        authToken = data.token;
                        currentAdmin = user;
                        showAdminDashboard();
                        loadDashboardData();
                        loadSitesForActiveSelector();
                    } else {
                        showError('loginError', 'Access denied. System admin privileges required.');
                    }
                } else {
                    showError('loginError', data.error || 'Login failed');
                }
            } catch (error) {
                console.error('Admin login error:', error);
                showError('loginError', 'Network error. Please try again.');
            }
        }

        function adminLogout() {
            localStorage.removeItem('adminAuthToken');
            localStorage.removeItem('currentAdmin');
            authToken = null;
            currentAdmin = {};
            showAdminLogin();
        }

        function showSection(sectionName) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = Array.from(document.querySelectorAll('.nav-item')).find(el => {
                const oc = el.getAttribute('onclick') || '';
                return oc.includes(`showSection('${sectionName}')`);
            });
            if (activeItem) activeItem.classList.add('active');
            
            // Update content
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`${sectionName}-section`).classList.add('active');
            
            // Update title
            const titles = {
                dashboard: 'Dashboard',
                organizations: 'Organizations',
                sites: 'Sites & Clubs',
                screens: 'Screen Management',
                onboarding: 'Onboarding',
                users: 'User Management',
                settings: 'System Settings',
                analytics: 'Analytics',
                logs: 'System Logs'
            };
            document.getElementById('sectionTitle').textContent = titles[sectionName] || sectionName;
            
            // Load section-specific data
            if (sectionName === 'organizations') {
                loadOrganizations();
            } else if (sectionName === 'sites') {
                loadSites();
            } else if (sectionName === 'screens') {
                loadScreens();
            } else if (sectionName === 'onboarding') {
                // Optionally refresh iframe when navigating in
                updateOnboardingTargets();
            } else if (sectionName === 'users') {
                loadUsers();
            }
        }

        function reloadOnboarding() {
            const f = document.getElementById('onboardingFrame');
            if (f) f.contentWindow ? f.contentWindow.location.reload() : (f.src = f.src);
        }

        function getActiveSiteId() {
            const sel = document.getElementById('activeSiteSelect');
            const val = sel && sel.value ? parseInt(sel.value) : null;
            return val || parseInt(localStorage.getItem('activeSiteId') || '1');
        }

        function updateOnboardingTargets() {
            const siteId = getActiveSiteId();
            if (siteId) localStorage.setItem('activeSiteId', String(siteId));
            const frame = document.getElementById('onboardingFrame');
            const link = document.getElementById('onboardingNewTab');
            const url = `/onboarding-wireframe.html?site_id=${encodeURIComponent(siteId || 1)}`;
            if (frame && frame.src && !frame.src.endsWith(url)) frame.src = url;
            if (link) link.href = url;
        }

        async function loadSitesForActiveSelector() {
            try {
                const response = await fetch(`${API_BASE}/admin/sites`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!response.ok) return;
                const sites = await response.json();
                const sel = document.getElementById('activeSiteSelect');
                if (!sel) return;
                sel.innerHTML = sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                // Select saved site or first
                const saved = localStorage.getItem('activeSiteId');
                if (saved && sites.some(s => String(s.id) === saved)) {
                    sel.value = saved;
                } else if (sites.length) {
                    sel.value = String(sites[0].id);
                    localStorage.setItem('activeSiteId', String(sites[0].id));
                }
                updateOnboardingTargets();
                sel.onchange = () => updateOnboardingTargets();
            } catch (e) {
                console.error('Error loading sites for active selector:', e);
            }
        }

        async function loadDashboardData() {
            try {
                // Load basic statistics
                const response = await fetch(`${API_BASE}/admin/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    // Extract data from the API response format {success: true, data: {...}}
                    const stats = result.success ? result.data : result;
                    document.getElementById('totalOrganizations').textContent = stats.totalOrganizations || 0;
                    document.getElementById('totalSites').textContent = stats.activeSites || 0;
                    document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
                    document.getElementById('activeSessions').textContent = '1'; // Current admin session
                } else {
                    console.error('Error loading dashboard stats');
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadOrganizations() {
            try {
                const response = await fetch(`${API_BASE}/admin/organizations`);

                if (response.ok) {
                    const result = await response.json();
                    // Extract data from the API response format {success: true, data: [...]}
                    const organizations = result.success ? result.data : result;
                    displayOrganizations(organizations);
                    populateOrganizationSelect(organizations);
                } else {
                    console.error('Failed to load organizations:', response.status);
                }
            } catch (error) {
                console.error('Error loading organizations:', error);
            }
        }

        function populateOrganizationSelect(organizations) {
            const select = document.getElementById('siteOrganization');
            if (select) {
                select.innerHTML = '<option value="">Select Organization</option>' +
                    organizations.map(org => `<option value="${org.id}">${org.name}</option>`).join('');
            }
        }

        function displayOrganizations(organizations) {
            const tbody = document.getElementById('organizationsList');
            tbody.innerHTML = organizations.map(org => `
                <tr>
                    <td>
                        <strong>${org.name}</strong><br>
                        <small style="color: #64748b;">${org.description || 'No description'}</small>
                    </td>
                    <td>${org.email || 'N/A'}</td>
                    <td>${org.site_count || 0}</td>
                    <td>${org.total_users || 0}</td>
                    <td>${new Date(org.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editOrganization(${org.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteOrganization(${org.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Modal functions
        function showModal(modalId) {
            // Reset edit state and modal titles for add operations
            if (modalId === 'organizationModal') {
                const form = document.getElementById('organizationForm');
                delete form.dataset.editId;
                document.getElementById('organizationModalLabel').textContent = 'Add Organization';
                form.reset();
            } else if (modalId === 'siteModal') {
                const form = document.getElementById('siteForm');
                delete form.dataset.editId;
                document.getElementById('siteModalLabel').textContent = 'Add Site';
                form.reset();
                loadOrganizationsForSelect();
            } else if (modalId === 'userModal') {
                const form = document.getElementById('userForm');
                delete form.dataset.editId;
                document.getElementById('userModalLabel').textContent = 'Add User';
                form.reset();
                loadSitesForSelect();
            }
            
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function editOrganization(orgId) {
            try {
                const response = await fetch(`${API_BASE}/admin/organizations`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    const organizations = result.success ? result.data : result;
                    const org = organizations.find(o => o.id === orgId);
                    
                    if (org) {
                        // Pre-populate the form with existing data
                        document.getElementById('orgName').value = org.name;
                        document.getElementById('orgSlug').value = org.slug;
                        document.getElementById('orgEmail').value = org.email;
                        document.getElementById('orgPhone').value = org.phone || '';
                        document.getElementById('orgDescription').value = org.description || '';
                        
                        // Store the ID for updating
                        document.getElementById('organizationForm').dataset.editId = orgId;
                        document.getElementById('organizationModalLabel').textContent = 'Edit Organization';
                        
                        // Show modal
                        const modal = new bootstrap.Modal(document.getElementById('organizationModal'));
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('Error loading organization for edit:', error);
                alert('Error loading organization data');
            }
        }

        async function editSite(siteId) {
            try {
                const response = await fetch(`${API_BASE}/admin/sites`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    const sites = result.success ? result.data : result;
                    const site = sites.find(s => s.id === siteId);
                    
                    if (site) {
                        // Load organizations for dropdown
                        await loadOrganizationsForSelect();
                        
                        // Pre-populate the form with existing data
                        document.getElementById('siteName').value = site.name;
                        document.getElementById('siteOrganization').value = site.organizationId;
                        document.getElementById('siteUrl').value = site.url || '';
                        
                        // Store the ID for updating
                        document.getElementById('siteForm').dataset.editId = siteId;
                        document.getElementById('siteModalLabel').textContent = 'Edit Site';
                        
                        // Show modal
                        const modal = new bootstrap.Modal(document.getElementById('siteModal'));
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('Error loading site for edit:', error);
                alert('Error loading site data');
            }
        }

        async function deleteOrganization(orgId) {
            if (confirm('Are you sure you want to delete this organization? This will also delete all associated sites and users.')) {
                try {
                    const response = await fetch(`${API_BASE}/admin/organizations/${orgId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (response.ok) {
                        loadOrganizations();
                        loadDashboardData(); // Refresh stats
                    } else {
                        const error = await response.json();
                        alert('Error deleting organization: ' + (error.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error deleting organization:', error);
                }
            }
        }

        async function deleteSite(siteId) {
            if (confirm('Are you sure you want to delete this site? This will also delete all associated users.')) {
                try {
                    const response = await fetch(`${API_BASE}/admin/sites/${siteId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (response.ok) {
                        loadSites();
                        loadDashboardData(); // Refresh stats
                    } else {
                        const error = await response.json();
                        alert('Error deleting site: ' + (error.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error deleting site:', error);
                }
            }
        }

        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 5000);
        }

        async function saveOrganization(event) {
            event.preventDefault();
            
            const form = document.getElementById('organizationForm');
            const editId = form.dataset.editId;
            const isEditing = !!editId;
            
            let name = document.getElementById('orgName').value;
            let slug = document.getElementById('orgSlug').value.trim();
            if (!slug) {
                // Auto-generate slug from name
                slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            }
            const formData = {
                name,
                slug,
                description: document.getElementById('orgDescription').value,
                email: document.getElementById('orgEmail').value,
                phone: document.getElementById('orgPhone').value
            };
            
            try {
                const url = isEditing ? `${API_BASE}/admin/organizations/${editId}` : `${API_BASE}/admin/organizations`;
                const method = isEditing ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    hideModal('organizationModal');
                    form.reset();
                    delete form.dataset.editId; // Clear the edit ID
                    document.getElementById('organizationModalLabel').textContent = 'Add Organization'; // Reset modal title
                    loadOrganizations();
                    loadDashboardData(); // Refresh stats
                } else {
                    const error = await response.json();
                    alert(`Error ${isEditing ? 'updating' : 'creating'} organization: ` + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving organization:', error);
                alert('Network error. Please try again.');
            }
        }

        async function saveSite(event) {
            event.preventDefault();
            
            const form = document.getElementById('siteForm');
            const editId = form.dataset.editId;
            const isEditing = !!editId;
            
            const formData = {
                name: document.getElementById('siteName').value,
                organizationId: parseInt(document.getElementById('siteOrganization').value),
                url: document.getElementById('siteUrl').value || 'https://example.com'
            };
            
            try {
                const url = isEditing ? `${API_BASE}/admin/sites/${editId}` : `${API_BASE}/admin/sites`;
                const method = isEditing ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    hideModal('siteModal');
                    form.reset();
                    delete form.dataset.editId; // Clear the edit ID
                    document.getElementById('siteModalLabel').textContent = 'Add Site'; // Reset modal title
                    loadSites();
                    loadDashboardData(); // Refresh stats
                } else {
                    const error = await response.json();
                    alert(`Error ${isEditing ? 'updating' : 'creating'} site: ` + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving site:', error);
                alert('Network error. Please try again.');
            }
        }

        async function saveUser(event) {
            event.preventDefault();
            
            const form = document.getElementById('userForm');
            const editId = form.dataset.editId;
            const isEditing = !!editId;
            
            const formData = {
                username: document.getElementById('userName').value,
                fullName: document.getElementById('userFullName').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value,
                siteId: parseInt(document.getElementById('userSite').value) || null,
            };
            
            // Only include password if it's provided (for edits, empty password means don't change)
            const password = document.getElementById('userPassword').value;
            if (password || !isEditing) {
                formData.password = password;
            }
            
            try {
                const url = isEditing ? `${API_BASE}/admin/users/${editId}` : `${API_BASE}/admin/users`;
                const method = isEditing ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    hideModal('userModal');
                    form.reset();
                    delete form.dataset.editId; // Clear the edit ID
                    document.getElementById('userModalLabel').textContent = 'Add User'; // Reset modal title
                    loadUsers();
                    loadDashboardData(); // Refresh stats
                } else {
                    const error = await response.json();
                    alert(`Error ${isEditing ? 'updating' : 'creating'} user: ` + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving user:', error);
                alert('Network error. Please try again.');
            }
        }

        async function loadSites() {
            try {
                const [sitesResponse, orgsResponse] = await Promise.all([
                    fetch(`${API_BASE}/admin/sites`),
                    fetch(`${API_BASE}/admin/organizations`)
                ]);

                if (sitesResponse.ok && orgsResponse.ok) {
                    const sitesResult = await sitesResponse.json();
                    const orgsResult = await orgsResponse.json();
                    
                    const sites = sitesResult.success ? sitesResult.data : sitesResult;
                    const organizations = orgsResult.success ? orgsResult.data : orgsResult;
                    
                    // Create organization lookup map
                    const orgMap = {};
                    organizations.forEach(org => {
                        orgMap[org.id] = org.name;
                    });
                    
                    // Add organization names to sites
                    sites.forEach(site => {
                        site.organizationName = orgMap[site.organizationId] || 'Unknown';
                    });
                    
                    displaySites(sites);
                } else {
                    console.error('Failed to load sites or organizations');
                }
            } catch (error) {
                console.error('Error loading sites:', error);
            }
        }

        function displaySites(sites) {
            const tbody = document.getElementById('sitesList');
            tbody.innerHTML = sites.map(site => `
                <tr>
                    <td>
                        <strong>${site.name}</strong><br>
                        <small style="color: #64748b;">${site.url || 'No URL'}</small>
                    </td>
                    <td>${site.organizationName || 'N/A'}</td>
                    <td><span class="status-badge status-${site.status === 'active' ? 'active' : 'inactive'}">${site.status || 'Unknown'}</span></td>
                    <td>${site.user_count || 0}</td>
                    <td>${new Date(site.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editSite(${site.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSite(${site.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadUsers() {
            try {
                // Load sites first so we can display site names
                if (!window.sitesData) {
                    const sitesResponse = await fetch(`${API_BASE}/admin/sites`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (sitesResponse.ok) {
                        const sitesResult = await sitesResponse.json();
                        window.sitesData = sitesResult.success ? sitesResult.data : sitesResult;
                    }
                }

                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    // Extract users from the API response format {success: true, data: [...]}
                    const users = result.success ? result.data : result;
                    displayUsers(users);
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersList');
            tbody.innerHTML = users.map(user => {
                // Look up site name from the sites data
                let siteName = 'N/A';
                if (user.siteId || user.site_id) {
                    const siteId = user.siteId || user.site_id;
                    const site = window.sitesData && window.sitesData.find(s => s.id === parseInt(siteId));
                    siteName = site ? site.name : `Site ${siteId}`;
                }
                
                return `
                <tr>
                    <td>
                        <strong>${user.username}</strong><br>
                        <small style="color: #64748b;">${user.fullName || user.full_name || user.email}</small>
                    </td>
                    <td><span class="status-badge status-active">${user.role}</span></td>
                    <td>${siteName}</td>
                    <td>${user.last_login || user.lastLogin ? new Date(user.last_login || user.lastLogin).toLocaleDateString() : 'Never'}</td>
                    <td><span class="status-badge ${user.status === 'active' ? 'status-active' : 'status-inactive'}">${user.status === 'active' ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary me-1" onclick="editUser(${user.id})">Edit</button>
                        <button class="btn btn-sm btn-secondary me-1" onclick="toggleUserStatus(${user.id}, '${user.status === 'active' ? 'inactive' : 'active'}')">${user.status === 'active' ? 'Deactivate' : 'Activate'}</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        async function loadSitesForSelect() {
            try {
                const response = await fetch(`${API_BASE}/admin/sites`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    // Extract sites from the API response format {success: true, data: [...]}
                    const sites = result.success ? result.data : result;
                    const select = document.getElementById('userSite');
                    select.innerHTML = '<option value="">Select Site</option>' +
                        sites.map(site => `<option value="${site.id}">${site.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading sites for select:', error);
            }
        }

        async function loadOrganizationsForSelect() {
            try {
                const response = await fetch(`${API_BASE}/admin/organizations`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    // Extract organizations from the API response format {success: true, data: [...]}
                    const organizations = result.success ? result.data : result;
                    const select = document.getElementById('siteOrganization');
                    select.innerHTML = '<option value="">Select Organization</option>' +
                        organizations.map(org => `<option value="${org.id}">${org.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading organizations for select:', error);
            }
        }

        async function editUser(userId) {
            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    const users = result.success ? result.data : result;
                    const user = users.find(u => u.id === userId);
                    
                    if (user) {
                        // Load sites for dropdown
                        await loadSitesForSelect();
                        
                        // Pre-populate the form with existing data
                        document.getElementById('userName').value = user.username;
                        document.getElementById('userFullName').value = user.fullName || user.full_name || '';
                        document.getElementById('userEmail').value = user.email;
                        document.getElementById('userRole').value = user.role;
                        document.getElementById('userSite').value = user.siteId || user.site_id || '';
                        document.getElementById('userPassword').value = ''; // Don't pre-fill password
                        
                        // Store the ID for updating
                        document.getElementById('userForm').dataset.editId = userId;
                        document.getElementById('userModalLabel').textContent = 'Edit User';
                        
                        // Show modal
                        const modal = new bootstrap.Modal(document.getElementById('userModal'));
                        modal.show();
                    }
                }
            } catch (error) {
                console.error('Error loading user for edit:', error);
                alert('Error loading user data');
            }
        }

        async function toggleUserStatus(userId, newStatus) {
            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ is_active: newStatus })
                });

                if (response.ok) {
                    loadUsers(); // Refresh the users list
                } else {
                    alert('Error updating user status');
                }
            } catch (error) {
                console.error('Error toggling user status:', error);
            }
        }

        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                try {
                    const response = await fetch(`${API_BASE}/admin/users/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (response.ok) {
                        loadUsers(); // Refresh the users list
                        loadDashboardData(); // Refresh stats
                    } else {
                        alert('Error deleting user');
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                }
            }
        }

        function refreshLogs() {
            // Load system logs
            fetch(`${API_BASE}/admin/logs`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
            .then(response => response.json())
            .then(logs => {
                const tbody = document.getElementById('systemLogs');
                tbody.innerHTML = logs.map(log => `
                    <tr>
                        <td>${new Date(log.timestamp).toLocaleString()}</td>
                        <td><span class="status-badge status-active">${log.level}</span></td>
                        <td>${log.event}</td>
                        <td>${log.details}</td>
                    </tr>
                `).join('');
            })
            .catch(error => console.error('Error loading logs:', error));
        }

        // Screen Management Functions
        async function loadScreens() {
            try {
                const response = await fetch(`${API_BASE}/screens/list`);
                if (response.ok) {
                    const result = await response.json();
                    const screens = result.success ? result.data : result;
                    displayScreens(screens || []);
                } else {
                    console.error('Failed to load screens');
                    displayScreens([]);
                }
            } catch (error) {
                console.error('Error loading screens:', error);
                displayScreens([]);
            }
        }

        function displayScreens(screens) {
            const tbody = document.getElementById('screensList');
            if (screens.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #64748b;">
                            No screens paired yet. Generate a test pairing or use the CMS to pair screens.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = screens.map(screen => {
                const createdDate = new Date(screen.createdAt).toLocaleString();
                const lastSeenDate = screen.lastSeen ? new Date(screen.lastSeen).toLocaleString() : 'Never';
                const activatedDate = screen.activatedAt ? new Date(screen.activatedAt).toLocaleString() : 'Not activated';
                const statusClass = screen.activated ? 'status-active' : 'status-inactive';
                const statusText = screen.activated ? 'Active' : 'Waiting';

                return `
                    <tr>
                        <td><strong>${screen.pairingCode}</strong></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${createdDate}</td>
                        <td>${lastSeenDate}</td>
                        <td>${activatedDate}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="activateScreen('${screen.pairingCode}')" ${screen.activated ? 'disabled' : ''}>
                                ${screen.activated ? 'Activated' : 'Activate'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteScreen('${screen.pairingCode}')">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function generateTestScreen() {
            try {
                const response = await fetch(`${API_BASE}/screens/pair`, { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert(`Test screen generated! Pairing code: ${result.pairing_code}`);
                        loadScreens(); // Refresh the list
                    }
                } else {
                    alert('Failed to generate test screen');
                }
            } catch (error) {
                console.error('Error generating test screen:', error);
                alert('Error generating test screen');
            }
        }

        async function activateScreen(pairingCode) {
            try {
                const response = await fetch(`${API_BASE}/screens/activate/${pairingCode}`, { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('Screen activated successfully!');
                        loadScreens(); // Refresh the list
                    }
                } else {
                    alert('Failed to activate screen');
                }
            } catch (error) {
                console.error('Error activating screen:', error);
                alert('Error activating screen');
            }
        }

        async function deleteScreen(pairingCode) {
            if (confirm(`Are you sure you want to delete screen ${pairingCode}? This action cannot be undone.`)) {
                try {
                    const response = await fetch(`${API_BASE}/screens/delete/${pairingCode}`, { method: 'DELETE' });
                    if (response.ok) {
                        alert('Screen deleted successfully!');
                        loadScreens(); // Refresh the list
                    } else {
                        alert('Failed to delete screen');
                    }
                } catch (error) {
                    console.error('Error deleting screen:', error);
                    alert('Error deleting screen');
                }
            }
        }
    </script>
</body>
</html>
