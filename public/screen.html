<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Club Interactive Screen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .widget {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .image-banner {
            height: 300px;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .banner-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 1s ease-in-out;
        }

        .banner-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            font-size: 18px;
            color: rgba(255, 255, 255, 0.7);
        }

        .news-ticker {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            overflow: hidden;
            white-space: nowrap;
        }

        .ticker-content {
            display: inline-block;
            animation: scroll-left 30s linear infinite;
        }

        @keyframes scroll-left {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }

        .data-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .weather-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 18px;
        }

        .weather-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .poll-widget {
            text-align: center;
        }

        .poll-options {
            margin: 15px 0;
        }

        .poll-option {
            background: rgba(255, 255, 255, 0.1);
            margin: 8px 0;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .qr-code {
            width: 120px;
            height: 120px;
            background: white;
            margin: 15px auto;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-weight: bold;
        }

        .pairing-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
        }

        .pairing-code {
            font-size: 72px;
            font-weight: bold;
            margin: 30px 0;
            padding: 30px 60px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .loading {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hole-of-day {
            text-align: center;
        }

        .hole-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin: 15px 0;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
        }

        .widget h3 {
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 20px;
        }

        .no-data {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Pairing Screen -->
        <div id="pairingScreen" class="pairing-screen">
            <h1>Golf Club Interactive Screen</h1>
            <div class="loading"></div>
            <p style="margin-top: 20px;">Connecting to CMS...</p>
            <div id="pairingCodeDisplay" style="display: none;">
                <p>Enter this pairing code in the CMS:</p>
                <div class="pairing-code" id="pairingCode"></div>
                <p>Waiting for activation...</p>
            </div>
        </div>

        <!-- Main Screen Content -->
        <div id="mainScreen" class="container" style="display: none;">
            <div class="status-indicator"></div>
            
            <div class="header">
                <h1>Welcome to Greenfield Golf Club</h1>
                <div id="currentTime"></div>
            </div>

            <div class="main-content">
                <div class="left-panel">
                    <!-- Image Banner -->
                    <div class="widget">
                        <div class="image-banner" id="imageBanner">
                            <div class="banner-placeholder">
                                No images available for rotation
                            </div>
                        </div>
                    </div>

                    <!-- Handicaps/Leaderboard Display -->
                    <div class="widget" id="dataWidget">
                        <h3 id="dataTitle">Member Information</h3>
                        <div id="dataContent" class="no-data">
                            Loading data...
                        </div>
                    </div>
                </div>

                <div class="right-panel">
                    <!-- Weather Widget -->
                    <div class="widget">
                        <h3>Today's Weather</h3>
                        <div class="weather-info" id="weatherInfo">
                            <div class="weather-icon">☀️</div>
                            <div>
                                <div id="temperature">22°C</div>
                                <div id="weatherCondition">Partly Cloudy</div>
                            </div>
                        </div>
                    </div>

                    <!-- Hole of the Day -->
                    <div class="widget hole-of-day">
                        <h3>Hole of the Day</h3>
                        <div>
                            <strong>Hole 14 - The Challenge</strong>
                            <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='300' height='200' viewBox='0 0 300 200'><rect width='300' height='200' fill='%234a90e2'/><rect x='0' y='160' width='300' height='40' fill='%2368b85c'/><circle cx='250' cy='50' r='8' fill='%23fff'/><path d='M50 180 Q150 120 250 50' stroke='%23fff' stroke-width='3' fill='none'/><text x='150' y='100' text-anchor='middle' fill='%23fff' font-family='Arial' font-size='14'>Par 4 - 380 yards</text></svg>" 
                                 alt="Hole 14" class="hole-image">
                            <p>A challenging dogleg right with water hazards. Aim for the left side of the fairway for the best approach angle.</p>
                        </div>
                    </div>

                    <!-- Interactive Poll -->
                    <div class="widget poll-widget" id="pollWidget">
                        <h3>Quick Poll</h3>
                        <div id="pollContent" class="no-data">
                            No active polls
                        </div>
                    </div>
                </div>
            </div>

            <!-- News Ticker -->
            <div class="news-ticker">
                <div class="ticker-content" id="newsTicker">
                    Welcome to Greenfield Golf Club • Check our latest updates and announcements
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://golf-club-poc-2024-dth0c4hjd8ayfuf8.uksouth-01.azurewebsites.net/api';
        let pairingCode = null;
        let isActivated = false;
        let currentImageIndex = 0;
        let images = [];
        let rotationInterval = null;

        // Initialize screen
        initializeScreen();

        async function initializeScreen() {
            // Clear any old pairing data to force a fresh start
            localStorage.removeItem('pairingCode');
            localStorage.removeItem('isActivated');
            
            // Always request a new pairing code for demo purposes
            await requestPairingCode();
            checkActivationStatus();
        }

        async function requestPairingCode() {
            try {
                const response = await fetch(`${API_BASE}/screens/pair`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    pairingCode = data.pairing_code;
                    localStorage.setItem('pairingCode', pairingCode);
                    showPairingCode();
                } else {
                    setTimeout(requestPairingCode, 5000);
                }
            } catch (error) {
                console.error('Failed to get pairing code:', error);
                setTimeout(requestPairingCode, 5000);
            }
        }

        function showPairingCode() {
            document.getElementById('pairingCode').textContent = pairingCode;
            document.getElementById('pairingCodeDisplay').style.display = 'block';
        }

        async function checkActivationStatus() {
            if (isActivated) return;
            
            try {
                const response = await fetch(`${API_BASE}/screens/status/${pairingCode}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.activated) {
                        isActivated = true;
                        localStorage.setItem('isActivated', 'true');
                        showMainScreen();
                        startContentUpdates();
                        return;
                    }
                }
            } catch (error) {
                console.error('Failed to check activation status:', error);
            }
            
            // Check again in 3 seconds
            setTimeout(checkActivationStatus, 3000);
        }

        function showMainScreen() {
            document.getElementById('pairingScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'flex';
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
            const dateString = now.toLocaleDateString([], { 
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });
            
            document.getElementById('currentTime').innerHTML = 
                `<div style="font-size: 24px; font-weight: bold;">${timeString}</div>
                 <div style="font-size: 16px; opacity: 0.8;">${dateString}</div>`;
        }

        async function loadScreenContent() {
            try {
                const response = await fetch(`${API_BASE}/screen/content`);
                if (response.ok) {
                    const content = await response.json();
                    updateNewsTicker(content.news);
                    updateImageBanner(content.rotation_images, content.rotation_duration);
                    updateDataDisplay(content);
                    updatePollDisplay(content.polls);
                }
            } catch (error) {
                console.error('Failed to load content:', error);
            }
        }

        function updateNewsTicker(news) {
            const ticker = document.getElementById('newsTicker');
            if (news && news.length > 0) {
                const newsText = news.map(item => item.title + ': ' + item.content).join(' • ');
                ticker.textContent = newsText;
            } else {
                ticker.textContent = 'Welcome to Greenfield Golf Club • No current announcements';
            }
        }

        function updateImageBanner(rotationImages, duration) {
            const banner = document.getElementById('imageBanner');
            
            if (!rotationImages || rotationImages.length === 0) {
                banner.innerHTML = '<div class="banner-placeholder">No images available for rotation</div>';
                return;
            }

            images = rotationImages;
            currentImageIndex = 0;
            
            // Clear existing interval
            if (rotationInterval) {
                clearInterval(rotationInterval);
            }

            // Show first image
            showImage(currentImageIndex);
            
            // Start rotation if multiple images
            if (images.length > 1) {
                rotationInterval = setInterval(() => {
                    currentImageIndex = (currentImageIndex + 1) % images.length;
                    showImage(currentImageIndex);
                }, duration || 5000);
            }
        }

        function showImage(index) {
            const banner = document.getElementById('imageBanner');
            const image = images[index];
            
            if (image) {
                banner.innerHTML = `<img src="${API_BASE.replace('/api', '')}${image.path}" 
                                         alt="${image.original_name}" 
                                         class="banner-image">`;
            }
        }

        function updateDataDisplay(content) {
            const dataTitle = document.getElementById('dataTitle');
            const dataContent = document.getElementById('dataContent');
            
            if (content.handicaps && content.handicaps.length > 0) {
                dataTitle.textContent = 'Member Handicaps';
                dataContent.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Handicap</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${content.handicaps.slice(0, 10).map(h => `
                                <tr>
                                    <td>${h.name}</td>
                                    <td>${h.handicap}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (content.leaderboard && content.leaderboard.length > 0) {
                dataTitle.textContent = 'Tournament Leaderboard';
                dataContent.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Player</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${content.leaderboard.slice(0, 10).map((entry, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${entry.player_name}</td>
                                    <td>${entry.score}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                dataTitle.textContent = 'Member Information';
                dataContent.innerHTML = '<div class="no-data">No data available</div>';
            }
        }

        function updatePollDisplay(polls) {
            const pollContent = document.getElementById('pollContent');
            
            if (polls && polls.length > 0) {
                const activePoll = polls[0]; // Show first active poll
                pollContent.innerHTML = `
                    <div>
                        <h4>${activePoll.question}</h4>
                        <div class="poll-options">
                            ${activePoll.options.map(option => `
                                <div class="poll-option">
                                    ${option} (${activePoll.votes[option] || 0} votes)
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                pollContent.innerHTML = '<div class="no-data">No active polls</div>';
            }
        }

        function startContentUpdates() {
            // Load initial content
            loadScreenContent();
            
            // Update content every 30 seconds
            setInterval(loadScreenContent, 30000);
        }
    </script>
</body>
</html>